<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mi Biblioteca Personal</title>
    <style>
      /* Estilos generales */
      :root {
          --primary: #6d5dfc;
          --secondary: #8a92b2;
          --background: #f5f6fa;
          --card-bg: #ffffff;
          --text: #2e3353;
          --accent: #ff7eb6;
          --shadow: rgba(0, 0, 0, 0.1);
      }

      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
          background-color: var(--background);
          color: var(--text);
          line-height: 1.6;
          padding: 20px;
          max-width: 1200px;
          margin: 0 auto;
      }

      header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 20px 0;
          border-bottom: 1px solid var(--shadow);
          margin-bottom: 30px;
      }

      h1, h2, h3 {
          color: var(--primary);
          margin-bottom: 15px;
      }

      button {
          background-color: var(--primary);
          color: white;
          border: none;
          padding: 10px 15px;
          border-radius: 6px;
          cursor: pointer;
          transition: background-color 0.3s;
      }

      button:hover {
          background-color: #5a4de6;
      }

      input, select {
          padding: 10px;
          border: 1px solid #ddd;
          border-radius: 6px;
          margin-bottom: 15px;
          width: 100%;
      }

      .tabs {
          display: flex;
          margin-bottom: 20px;
          border-bottom: 1px solid var(--shadow);
      }

      .tab {
          padding: 10px 20px;
          cursor: pointer;
          border-bottom: 3px solid transparent;
      }

      .tab.active {
          border-bottom-color: var(--primary);
          color: var(--primary);
          font-weight: bold;
      }

      .tab-content {
          display: none;
      }

      .tab-content.active {
          display: block;
          animation: fadeIn 0.5s;
      }

      @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
      }

      /* Estilos para la sección de libros */
      .book-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
          gap: 20px;
          margin-top: 20px;
      }

      .book-card {
          background-color: var(--card-bg);
          border-radius: 10px;
          box-shadow: 0 4px 8px var(--shadow);
          padding: 15px;
          transition: transform 0.3s;
          position: relative;
      }

      .book-card:hover {
          transform: translateY(-5px);
      }

      .book-cover {
          width: 100%;
          height: 220px;
          object-fit: cover;
          border-radius: 6px;
          margin-bottom: 10px;
      }

      .book-status {
          position: absolute;
          top: 10px;
          right: 10px;
          width: 20px;
          height: 20px;
          border-radius: 50%;
      }

      .status-completed {
          background-color: #4cd137;
      }

      .status-reading {
          background-color: #fbc531;
      }

      .status-pending {
          background-color: #718093;
      }

      .book-progress {
          height: 6px;
          background-color: #ddd;
          border-radius: 3px;
          margin: 10px 0;
          overflow: hidden;
      }

      .progress-bar {
          height: 100%;
          background-color: var(--primary);
          transition: width 0.3s;
      }

      /* Estilos para marcadores */
      .bookmark-list {
          display: flex;
          flex-direction: column;
          gap: 10px;
      }

      .bookmark-item {
          display: flex;
          background-color: var(--card-bg);
          border-radius: 8px;
          padding: 15px;
          box-shadow: 0 2px 4px var(--shadow);
          align-items: center;
      }

      .bookmark-color {
          width: 20px;
          height: 20px;
          border-radius: 4px;
          margin-right: 15px;
      }

      .bookmark-info {
          flex-grow: 1;
      }

      /* Estilos para filtro de marcadores */
      .bookmark-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .bookmark-controls select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 0;
            max-width: 250px;
        }


      /* Separación de botones de marcadores */
      .bookmark-actions {
          display: flex;
          gap: 10px;
      }

      .modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          justify-content: center;
          align-items: center;
          z-index: 100;
      }

      .modal-content {
          background-color: var(--card-bg);
          padding: 25px;
          border-radius: 10px;
          width: 90%;
          max-width: 500px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }

      .color-picker {
          display: grid;
          grid-template-columns: repeat(5, 1fr);
          gap: 10px;
          margin: 15px 0;
      }

      .color-option {
          width: 30px;
          height: 30px;
          border-radius: 6px;
          cursor: pointer;
          transition: transform 0.2s;
      }

      .color-option:hover {
          transform: scale(1.1);
      }

      .close {
          color: var(--text);
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
          align-self: flex-end;
      }

      .form-group {
          margin-bottom: 15px;
      }

      .form-group label {
          display: block;
          margin-bottom: 5px;
          font-weight: 500;
      }

      /* Cambios para entrada de color personalizado */
      .custom-color-input {
          display: flex;
          gap: 10px;
          align-items: center;
          margin-top: 10px;
      }

      .custom-color-input input {
          flex: 1;
          margin-bottom: 0;
      }

      .custom-color-preview {
          width: 30px;
          height: 30px;
          border-radius: 6px;
          border: 1px solid #ddd;
      }

      /* Estilos para leyendas de colores */
        .bookmark-legend {
            font-size: 0.8em;
            background-color: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 5px;
            display: inline-block;
        }

        .color-legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .color-legend-item .color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
        }
        /* Estilos para lecturas online */
        .readings-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .filter-tags {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .tag-filter {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 0;
            max-width: 250px;
        }

        .online-readings-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .reading-item {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 8px var(--shadow);
            padding: 20px;
            transition: transform 0.3s;
        }

        .reading-item:hover {
            transform: translateY(-3px);
        }

        .reading-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .reading-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .reading-url {
            color: var(--secondary);
            margin-bottom: 10px;
            word-break: break-all;
        }

        .reading-description {
            margin-bottom: 15px;
        }

        .reading-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .reading-tag {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
        }

        .tag-text {
            margin-left: 2px;
        }

        .reading-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .reading-chapter {
            background-color: var(--background);
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin-top: 5px;
            font-style: italic;
        }

        /* Estilos para el formulario de etiquetas */
        .tag-color-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .tag-color-input label {
            font-weight: normal;
            margin-bottom: 0;
        }

        .tag-color-input input[type="color"] {
            width: 40px;
            height: 30px;
            padding: 0;
            border: 1px solid #ddd;
        }

        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
        }
        .reading-author {
            font-size: 1rem;
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 5px;
        }

      /* Responsive */
      @media (max-width: 768px) {
          .book-grid {
              grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
          }

          .book-card {
              padding: 10px;
          }

          .book-cover {
              height: 180px;
          }
      }

      @media (max-width: 480px) {
          body {
              padding: 10px;
          }

          header {
              flex-direction: column;
              gap: 15px;
              align-items: flex-start;
          }

          .tabs {
              width: 100%;
              overflow-x: auto;
              white-space: nowrap;
          }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Mi Biblioteca Personal</h1>
      <button id="add-book-btn">+ Añadir Libro</button>
    </header>

    <div class="tabs">
      <div class="tab active" data-tab="books">Mis Libros</div>
      <div class="tab" data-tab="online-readings">Lecturas Online</div>
      <div class="tab" data-tab="bookmarks">Mis Marcadores</div>
    </div>

    <div class="tab-content active" id="books-content">
      <input
        type="text"
        id="search-books"
        placeholder="Buscar por título o autor..."
      />
      <div class="book-grid" id="book-container">
        <!-- Los libros se cargarán aquí dinámicamente -->
      </div>
    </div>

    <div class="tab-content" id="bookmarks-content">
        <div class="bookmark-controls">
            <button id="add-bookmark-btn">+ Añadir Marcador</button>
            <select id="filter-bookmark-book">
                <option value="all">Todos los libros</option>
                <!-- Opciones de libros cargadas dinámicamente -->
            </select>
        </div>
        <div class="bookmark-list" id="bookmark-container">
            <!-- Los marcadores se cargarán aquí dinámicamente -->
        </div>
    </div>

    <div class="tab-content" id="online-readings-content">
        <div class="readings-actions">
            <button id="add-reading-btn">+ Añadir Lectura Online</button>
            <div class="filter-tags">
                <select id="filter-reading-tag" class="tag-filter">
                    <option value="all">Todas las etiquetas</option>
                    <!-- Las etiquetas se cargarán dinámicamente -->
                </select>
            </div>
        </div>
        <div class="online-readings-list" id="readings-container">
            <!-- Las lecturas online se cargarán aquí dinámicamente -->
        </div>
    </div>

    <!-- Modal para añadir/editar libro -->
    <div class="modal" id="book-modal">
      <div class="modal-content">
        <span class="close" id="close-book-modal">&times;</span>
        <h2 id="book-modal-title">Añadir Nuevo Libro</h2>
        <form id="book-form">
          <div class="form-group">
            <label for="title">Título:</label>
            <input type="text" id="title" required />
          </div>
          <div class="form-group">
            <label for="author">Autor:</label>
            <input type="text" id="author" />
          </div>
          <div class="form-group">
            <label for="cover-url">URL de la Portada:</label>
            <input type="url" id="cover-url" placeholder="http://..." />
          </div>
          <div class="form-group">
            <label for="total-pages">Número Total de Páginas:</label>
            <input type="number" id="total-pages" min="1" />
          </div>
          <div class="form-group">
            <label for="current-page">Página Actual:</label>
            <input type="number" id="current-page" min="0" />
          </div>
          <div class="form-group">
            <label for="status">Estado:</label>
            <select id="status">
              <option value="pending">Por Leer</option>
              <option value="reading">Leyendo</option>
              <option value="completed">Terminado</option>
            </select>
          </div>
          <button type="submit">Guardar</button>
        </form>
      </div>
    </div>

    <!-- Modal para añadir/editar marcador -->
    <div class="modal" id="bookmark-modal">
      <div class="modal-content">
        <span class="close" id="close-bookmark-modal">&times;</span>
        <h2 id="bookmark-modal-title">Añadir Nuevo Marcador</h2>
        <form id="bookmark-form">
          <div class="form-group">
            <label for="bookmark-book">Libro:</label>
            <select id="bookmark-book" required>
              <!-- Opciones de libros cargadas dinámicamente -->
            </select>
          </div>
          <div class="form-group">
            <label for="bookmark-page">Página:</label>
            <input type="number" id="bookmark-page" min="1" required />
          </div>
          <div class="form-group">
            <label for="bookmark-note">Nota:</label>
            <input
              type="text"
              id="bookmark-note"
              placeholder="Añade una nota (opcional)"
            />
          </div>
          <div class="form-group">
            <label>Color predefinido:</label>
            <div class="color-picker" id="color-picker">
              <div
                class="color-option"
                style="background-color: #f78b39;"
                data-color="#f78b39"
              ></div>
              <div
                class="color-option"
                style="background-color: #5376b5;"
                data-color="#5376b5"
              ></div>
              <div
                class="color-option"
                style="background-color: #399947;"
                data-color="#399947"
              ></div>
              <div
                class="color-option"
                style="background-color: #f0d069;"
                data-color="#f0d069"
              ></div>
              <div
                class="color-option"
                style="background-color: #a29bfe;"
                data-color="#a29bfe"
              ></div>
              <div
                class="color-option"
                style="background-color: #fd79a8;"
                data-color="#fd79a8"
              ></div>
              <div
                class="color-option"
                style="background-color: #e3193b;"
                data-color="#e3193b"
              ></div>
              <div
                class="color-option"
                style="background-color: #fdcb6e;"
                data-color="#fdcb6e"
              ></div>
              <div
                class="color-option"
                style="background-color: #e84393;"
                data-color="#e84393"
              ></div>
              <div
                class="color-option"
                style="background-color: #b570e0;"
                data-color="#b570e0"
              ></div>
            </div>
          </div>
          <div class="form-group">
            <label for="custom-color"
              >O ingresa código HEX personalizado:</label
            >
            <div class="custom-color-input">
              <input
                type="text"
                id="custom-color"
                placeholder="#RRGGBB"
                pattern="^#([A-Fa-f0-9]{6})$"
              />
              <div class="custom-color-preview" id="color-preview"></div>
            </div>
          </div>
          <input type="hidden" id="bookmark-color" value="#ff7675" />
          <div class="form-group">
            <label for="bookmark-legend">Leyenda del color:</label>
            <input type="text" id="bookmark-legend" placeholder="Ej: Idea importante, Frase destacada...">
        </div>
          <button type="submit">Guardar</button>
        </form>
      </div>
    </div>
   
    <!-- Modal para añadir/editar lectura online -->
    <div class="modal" id="reading-modal">
        <div class="modal-content">
            <span class="close" id="close-reading-modal">&times;</span>
            <h2 id="reading-modal-title">Añadir Nueva Lectura Online</h2>
            <form id="reading-form">
                <div class="form-group">
                    <label for="reading-title">Título:</label>
                    <input type="text" id="reading-title" required>
                </div>
                <div class="form-group">
                    <label for="reading-author">Autor (opcional):</label>
                    <input type="text" id="reading-author">
                </div>
                <div class="form-group">
                    <label for="reading-url">URL:</label>
                    <input type="url" id="reading-url" placeholder="https://..." required>
                </div>
                <div class="form-group">
                    <label for="reading-chapter">Capítulo actual:</label>
                    <input type="text" id="reading-chapter">
                </div>
                <div class="form-group">
                    <label for="readingchap-url">URL del cap actual si necesario:</label>
                    <input type="url" id="readingchap-url" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label for="reading-description">Descripción:</label>
                    <textarea id="reading-description" rows="3" placeholder="Breve descripción (opcional)"></textarea>
                </div>
                <div class="form-group">
                    <label for="reading-tags">Etiquetas (separadas por comas):</label>
                    <input type="text" id="reading-tags" placeholder="Ej: programación, javascript, tutorial">
                </div>
                <div id="tag-colors-container">
                    <!-- Aquí se generarán dinámicamente los campos para los colores de las etiquetas -->
                </div>
                <button type="submit">Guardar</button>
            </form>
        </div>
    </div>

    <script>
      // Almacenamiento de datos
      let books = JSON.parse(localStorage.getItem('books')) || [];
      let bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || [];
      
      let editingBookId = null;
      let editingBookmarkId = null;
      let selectedColor = "#ff7675";

      // Elementos DOM
      const filterBookmarkSelect = document.getElementById('filter-bookmark-book');
      const bookContainer = document.getElementById('book-container');
      const bookmarkContainer = document.getElementById('bookmark-container');
      const bookModal = document.getElementById('book-modal');
      const bookmarkModal = document.getElementById('bookmark-modal');
      const bookForm = document.getElementById('book-form');
      const bookmarkForm = document.getElementById('bookmark-form');
      const addBookBtn = document.getElementById('add-book-btn');
      const addBookmarkBtn = document.getElementById('add-bookmark-btn');
      const closeBookModal = document.getElementById('close-book-modal');
      const closeBookmarkModal = document.getElementById('close-bookmark-modal');
      const searchInput = document.getElementById('search-books');
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      const bookModalTitle = document.getElementById('book-modal-title');
      const bookmarkModalTitle = document.getElementById('bookmark-modal-title');
      const colorOptions = document.querySelectorAll('.color-option');
      const bookmarkBookSelect = document.getElementById('bookmark-book');
      const customColorInput = document.getElementById('custom-color');
      const colorPreview = document.getElementById('color-preview');

      // Inicializar la aplicación
      function init() {
        renderBooks();
        renderBookmarks();
        renderOnlineReadings();
        updateBookSelectOptions();
        updateTagFilterOptions();
        setupEventListeners();
        setupReadingEventListeners();
      }

      // Configurar event listeners
      function setupEventListeners() {
            filterBookmarkSelect.addEventListener('change', renderBookmarks);
          // Event listeners para pestañas
          tabs.forEach(tab => {
              tab.addEventListener('click', () => {
                  tabs.forEach(t => t.classList.remove('active'));
                  tab.classList.add('active');

                  const tabName = tab.getAttribute('data-tab');
                  tabContents.forEach(content => {
                      content.classList.remove('active');
                  });
                  document.getElementById(`${tabName}-content`).classList.add('active');
              });
          });

          // Event listeners para modales
          addBookBtn.addEventListener('click', () => {
              editingBookId = null;
              bookModalTitle.textContent = 'Añadir Nuevo Libro';
              bookForm.reset();
              bookModal.style.display = 'flex';
          });

          addBookmarkBtn.addEventListener('click', () => {
              if (books.length === 0) {
                  alert('Primero debes añadir al menos un libro');
                  return;
              }
              editingBookmarkId = null;
              bookmarkModalTitle.textContent = 'Añadir Nuevo Marcador';
              bookmarkForm.reset();
              document.getElementById('bookmark-color').value = "#ff7675";
              customColorInput.value = "";
              colorPreview.style.backgroundColor = "#ff7675";
              highlightSelectedColor("#ff7675");
              bookmarkModal.style.display = 'flex';
          });

          closeBookModal.addEventListener('click', () => {
              bookModal.style.display = 'none';
          });

          closeBookmarkModal.addEventListener('click', () => {
              bookmarkModal.style.display = 'none';
          });

          // Cerrar modal al hacer clic fuera
          window.addEventListener('click', (e) => {
              if (e.target === bookModal) {
                  bookModal.style.display = 'none';
              }
              if (e.target === bookmarkModal) {
                  bookmarkModal.style.display = 'none';
              }
          });

          // Event listener para buscar libros
          searchInput.addEventListener('input', renderBooks);

          // Event listeners para formularios
          bookForm.addEventListener('submit', handleBookFormSubmit);
          bookmarkForm.addEventListener('submit', handleBookmarkFormSubmit);

          // Event listeners para selección de color
          colorOptions.forEach(option => {
              option.addEventListener('click', () => {
                  const color = option.getAttribute('data-color');
                  document.getElementById('bookmark-color').value = color;
                  customColorInput.value = "";
                  highlightSelectedColor(color);
              });
          });

          // Event listener para color personalizado
          customColorInput.addEventListener('input', function() {
              const colorValue = this.value;
              if (/^#([A-Fa-f0-9]{6})$/.test(colorValue)) {
                  colorPreview.style.backgroundColor = colorValue;
                  document.getElementById('bookmark-color').value = colorValue;
                  unhighlightAllColors();
              }
          });
      }

      // Render libros
      function renderBooks() {
          const searchTerm = searchInput.value.toLowerCase();
          const filteredBooks = books.filter(book =>
              book.title.toLowerCase().includes(searchTerm) ||
              book.author.toLowerCase().includes(searchTerm)
          );

          bookContainer.innerHTML = '';

          if (filteredBooks.length === 0) {
              bookContainer.innerHTML = '<p class="empty-message">No se encontraron libros. ¡Añade uno nuevo!</p>';
              return;
          }

          filteredBooks.forEach(book => {
              const progress = book.totalPages > 0 ? (book.currentPage / book.totalPages * 100) : 0;
              const statusClass = `status-${book.status}`;

              const bookCard = document.createElement('div');
              bookCard.className = 'book-card';
              bookCard.innerHTML = `
                  <div class="book-status ${statusClass}"></div>
                  <img src="${book.coverUrl || '/api/placeholder/200/300'}" alt="${book.title}" class="book-cover">
                  <h3>${book.title}</h3>
                  <p>${book.author}</p>
                  <div class="book-progress">
                      <div class="progress-bar" style="width: ${progress}%"></div>
                  </div>
                  <p>${book.currentPage} de ${book.totalPages} páginas (${Math.round(progress)}%)</p>
                  <button class="edit-book" data-id="${book.id}">Editar</button>
                  <button class="delete-book" data-id="${book.id}">Eliminar</button>
              `;

              bookContainer.appendChild(bookCard);

              // Event listeners para botones de editar y eliminar
              bookCard.querySelector('.edit-book').addEventListener('click', () => editBook(book.id));
              bookCard.querySelector('.delete-book').addEventListener('click', () => deleteBook(book.id));
          });
      }

      // Render marcadores
      function renderBookmarks() {
          bookmarkContainer.innerHTML = '';

          const selectedBookId = filterBookmarkSelect.value;
          let filteredBookmarks = bookmarks;

          if (selectedBookId !== 'all') {
            filteredBookmarks = bookmarks.filter(bookmark => bookmark.bookId === selectedBookId);
            }
    
         if (filteredBookmarks.length === 0) {
            bookmarkContainer.innerHTML = '<p class="empty-message">No se encontraron marcadores con los filtros actuales.</p>';
            return;
         }
        
         filteredBookmarks.forEach(bookmark => {
            const book = books.find(b => b.id === bookmark.bookId);
            if (!book) return;
            
            const bookmarkItem = document.createElement('div');
            bookmarkItem.className = 'bookmark-item';
            bookmarkItem.innerHTML = `
                <div class="bookmark-color" style="background-color: ${bookmark.color}"></div>
                <div class="bookmark-info">
                    <h3>${book.title}</h3>
                    <p>Página ${bookmark.page} de ${book.totalPages}</p>
                    ${bookmark.note ? `<p>${bookmark.note}</p>` : ''}
                    ${bookmark.legend ? `<span class="bookmark-legend">
                        <div class="color-legend-item">
                            <div class="color-dot" style="background-color: ${bookmark.color}"></div>
                            ${bookmark.legend}
                        </div>
                    </span>` : ''}
                </div>
                <div class="bookmark-actions">
                    <button class="edit-bookmark" data-id="${bookmark.id}">Editar</button>
                    <button class="delete-bookmark" data-id="${bookmark.id}">Eliminar</button>
                </div>
                `;
            
             bookmarkContainer.appendChild(bookmarkItem);
            
              // Event listeners para botones de editar y eliminar
             bookmarkItem.querySelector('.edit-bookmark').addEventListener('click', () => editBookmark(bookmark.id));
             bookmarkItem.querySelector('.delete-bookmark').addEventListener('click', () => deleteBookmark(bookmark.id));
            });
        }

        // Actualizar opciones de libros en el formulario de marcadores
        function updateBookSelectOptions() {
            bookmarkBookSelect.innerHTML = '';
            filterBookmarkSelect.innerHTML = '<option value="all">Todos los libros</option>';

            books.forEach(book => {
                const option = document.createElement('option');
                option.value = book.id;
                option.textContent = book.title;
                bookmarkBookSelect.appendChild(option);

                const filterOption = option.cloneNode(true);
                filterBookmarkSelect.appendChild(filterOption);
          });
      }

      // Manejar envío del formulario de libros
      function handleBookFormSubmit(e) {
          e.preventDefault();

          const title = document.getElementById('title').value;
          const author = document.getElementById('author').value;
          const coverUrl = document.getElementById('cover-url').value;
          const totalPages = parseInt(document.getElementById('total-pages').value) || 0;
          const currentPage = parseInt(document.getElementById('current-page').value) || 0;
          const status = document.getElementById('status').value;

          if (!title) {
              alert('El título es obligatorio');
              return;
          }

          if (editingBookId) {
              // Editar libro existente
              const index = books.findIndex(book => book.id === editingBookId);
              if (index !== -1) {
                  books[index] = {
                      ...books[index],
                      title,
                      author,
                      coverUrl,
                      totalPages,
                      currentPage,
                      status
                  };
              }
          } else {
              // Añadir nuevo libro
              const newBook = {
                  id: Date.now().toString(),
                  title,
                  author,
                  coverUrl,
                  totalPages,
                  currentPage,
                  status
              };
              books.push(newBook);
          }

          saveBooks();
          bookModal.style.display = 'none';
          renderBooks();
          updateBookSelectOptions();
      }

      // Manejar envío del formulario de marcadores
      function handleBookmarkFormSubmit(e) {
          e.preventDefault();

          const bookId = document.getElementById('bookmark-book').value;
          const page = parseInt(document.getElementById('bookmark-page').value);
          const note = document.getElementById('bookmark-note').value;
          const color = document.getElementById('bookmark-color').value;
          const legend = document.getElementById('bookmark-legend').value;

          if (!bookId || !page) {
              alert('El libro y la página son obligatorios');
              return;
          }

          const book = books.find(b => b.id === bookId);
          if (!book) {
              alert('Libro no encontrado');
              return;
          }

          if (page > book.totalPages) {
              alert(`El libro solo tiene ${book.totalPages} páginas`);
              return;
          }

          if (editingBookmarkId) {
              // Editar marcador existente
              const index = bookmarks.findIndex(bookmark => bookmark.id === editingBookmarkId);
              if (index !== -1) {
                  bookmarks[index] = {
                      ...bookmarks[index],
                      bookId,
                      page,
                      note,
                      color,
                      legend
                  };
              }
          } else {
              // Añadir nuevo marcador
              const newBookmark = {
                  id: Date.now().toString(),
                  bookId,
                  page,
                  note,
                  color,
                  legend
              };
              bookmarks.push(newBookmark);
          }

          saveBookmarks();
          bookmarkModal.style.display = 'none';
          renderBookmarks();
      }

      // Editar libro
      function editBook(id) {
          const book = books.find(book => book.id === id);
          if (!book) return;

          editingBookId = id;
          bookModalTitle.textContent = 'Editar Libro';

          document.getElementById('title').value = book.title;
          document.getElementById('author').value = book.author || '';
          document.getElementById('cover-url').value = book.coverUrl || '';
          document.getElementById('total-pages').value = book.totalPages || '';
          document.getElementById('current-page').value = book.currentPage || '';
          document.getElementById('status').value = book.status;

          bookModal.style.display = 'flex';
      }

      // Eliminar libro
      function deleteBook(id) {
          if (!confirm('¿Estás seguro de que quieres eliminar este libro? También se eliminarán todos sus marcadores.')) {
              return;
          }

          books = books.filter(book => book.id !== id);
          bookmarks = bookmarks.filter(bookmark => bookmark.bookId !== id);

          saveBooks();
          saveBookmarks();
          renderBooks();
          renderBookmarks();
          updateBookSelectOptions();
      }

      // Editar marcador
      function editBookmark(id) {
          const bookmark = bookmarks.find(bookmark => bookmark.id === id);
          if (!bookmark) return;

          editingBookmarkId = id;
          bookmarkModalTitle.textContent = 'Editar Marcador';

          document.getElementById('bookmark-book').value = bookmark.bookId;
          document.getElementById('bookmark-page').value = bookmark.page;
          document.getElementById('bookmark-note').value = bookmark.note || '';
          document.getElementById('bookmark-color').value = bookmark.color;
          document.getElementById('bookmark-legend').value = bookmark.legend || '';

          // Verificar si el color es uno de los predefinidos
          const predefinedColor = Array.from(colorOptions).find(
              option => option.getAttribute('data-color') === bookmark.color
          );

          if (predefinedColor) {
              highlightSelectedColor(bookmark.color);
              customColorInput.value = '';
          } else {
              unhighlightAllColors();
              customColorInput.value = bookmark.color;
          }

          colorPreview.style.backgroundColor = bookmark.color;
          bookmarkModal.style.display = 'flex';
      }

      // Eliminar marcador
      function deleteBookmark(id) {
          if (!confirm('¿Estás seguro de que quieres eliminar este marcador?')) {
              return;
          }

          bookmarks = bookmarks.filter(bookmark => bookmark.id !== id);

          saveBookmarks();
          renderBookmarks();
      }

      // Resaltar color seleccionado
      function highlightSelectedColor(color) {
          colorOptions.forEach(option => {
              if (option.getAttribute('data-color') === color) {
                  option.style.border = '3px solid black';
              } else {
                  option.style.border = 'none';
              }
          });
      }

      // Quitar resaltado de todos los colores
      function unhighlightAllColors() {
          colorOptions.forEach(option => {
              option.style.border = 'none';
          });
      }

      // Guardar libros en localStorage
      function saveBooks() {
          localStorage.setItem('books', JSON.stringify(books));
      }

      // Guardar marcadores en localStorage
      function saveBookmarks() {
          localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
      }
      // Variables para lecturas online
        let onlineReadings = JSON.parse(localStorage.getItem('onlineReadings')) || [];
        let allTags = new Set();
        let editingReadingId = null;
        const readingsContainer = document.getElementById('readings-container');
        const readingModal = document.getElementById('reading-modal');
        const addReadingBtn = document.getElementById('add-reading-btn');
        const closeReadingModal = document.getElementById('close-reading-modal');
        const readingForm = document.getElementById('reading-form');
        const readingModalTitle = document.getElementById('reading-modal-title');
        const filterTagSelect = document.getElementById('filter-reading-tag');
        const tagColorsContainer = document.getElementById('tag-colors-container');

        // Extraer todas las etiquetas únicas
        function extractAllTags() {
            allTags.clear();
            onlineReadings.forEach(reading => {
                if (reading.tags && reading.tags.length > 0) {
                    reading.tags.forEach(tag => allTags.add(tag.text));
                }
            });
            return Array.from(allTags);
        }

        // Actualizar opciones de filtro de etiquetas
        function updateTagFilterOptions() {
            const tags = extractAllTags();
            filterTagSelect.innerHTML = '<option value="all">Todas las etiquetas</option>';
            
            tags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                filterTagSelect.appendChild(option);
            });
        }

        // Generar campos de color para etiquetas
        function generateTagColorInputs(tagsArray) {
            tagColorsContainer.innerHTML = '';
            
            if (!tagsArray || tagsArray.length === 0) {
                tagColorsContainer.innerHTML = '<p>Introduce etiquetas para asignarles colores</p>';
                return;
            }
            
            const tagColorTitle = document.createElement('h3');
            tagColorTitle.textContent = 'Colores para etiquetas:';
            tagColorTitle.style.marginTop = '15px';
            tagColorTitle.style.fontSize = '1rem';
            tagColorsContainer.appendChild(tagColorTitle);
            
            tagsArray.forEach(tag => {
                const tagColorGroup = document.createElement('div');
                tagColorGroup.className = 'tag-color-input';
                
                const label = document.createElement('label');
                label.textContent = tag;
                
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.id = `color-${tag}`;
                colorInput.value = '#6d5dfc'; // Color por defecto
                
                tagColorGroup.appendChild(label);
                tagColorGroup.appendChild(colorInput);
                tagColorsContainer.appendChild(tagColorGroup);
            });
        }

        // Renderizar lecturas online
        function renderOnlineReadings() {
            readingsContainer.innerHTML = '';
            
            const selectedTag = filterTagSelect.value;
            let filteredReadings = onlineReadings;
            
            if (selectedTag !== 'all') {
                filteredReadings = onlineReadings.filter(reading => 
                    reading.tags && reading.tags.some(tag => tag.text === selectedTag)
                );
            }
            
            if (filteredReadings.length === 0) {
                readingsContainer.innerHTML = '<p class="empty-message">No se encontraron lecturas online. ¡Añade una nueva!</p>';
                return;
            }
            
            filteredReadings.forEach(reading => {
                const readingItem = document.createElement('div');
                readingItem.className = 'reading-item';
                
                let tagsHTML = '';
                if (reading.tags && reading.tags.length > 0) {
                    tagsHTML = '<div class="reading-tags">';
                    reading.tags.forEach(tag => {
                        // Determinar el color del texto (blanco o negro) según el color de fondo
                        const bgColor = tag.color.replace('#', '');
                        const r = parseInt(bgColor.substr(0, 2), 16);
                        const g = parseInt(bgColor.substr(2, 2), 16);
                        const b = parseInt(bgColor.substr(4, 2), 16);
                        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                        const textColor = brightness > 128 ? 'black' : 'white';
                        
                        tagsHTML += `<span class="reading-tag" style="background-color: ${tag.color}; color: ${textColor}">
                            <span class="tag-text">${tag.text}</span>
                        </span>`;
                    });
                    tagsHTML += '</div>';
                }
                
                readingItem.innerHTML = `
                    <div class="reading-header">
                        <div>
                            <div class="reading-title">${reading.title}</div>
                            <div class="reading-author">${reading.author ? `<p>${reading.author}</p>` : ''}</div>
                            ${reading.description ? `<div class="reading-description">${reading.description}</div>` : ''}
                            <a>Link Primer Cap:</a>
                            <a href="${reading.url}" target="_blank" class="reading-url">${reading.url}</a>
                           ${reading.chapter ? `<div class="online-chapter">Capítulo actual: ${reading.chapter}</div>` : ''}
                           <a>Link Cap Actual:</a>
                           <a href="${reading.chapUrl}" target="_blank" class="readingchap-url">${reading.chapUrl}</a>
                        </div>
                    </div>
                    ${tagsHTML}
                    <div class="reading-actions">
                        <button class="edit-reading" data-id="${reading.id}">Editar</button>
                        <button class="delete-reading" data-id="${reading.id}">Eliminar</button>
                    </div>
                `;
                
                readingsContainer.appendChild(readingItem);
                
                // Event listeners para botones de editar y eliminar
                readingItem.querySelector('.edit-reading').addEventListener('click', () => editReading(reading.id));
                readingItem.querySelector('.delete-reading').addEventListener('click', () => deleteReading(reading.id));
            });
        }

        // Manejar envío del formulario de lecturas online
        function handleReadingFormSubmit(e) {
            e.preventDefault();
            
            const title = document.getElementById('reading-title').value;
            const author = document.getElementById('reading-author').value;
            const url = document.getElementById('reading-url').value;
            const description = document.getElementById('reading-description').value;
            const chapter = document.getElementById('reading-chapter').value;
            const chapUrl= document.getElementById('readingchap-url').value;
            const tagsInput = document.getElementById('reading-tags').value;
            
            if (!title || !url) {
                alert('El título y la URL son obligatorios');
                return;
            }
            
            // Procesar etiquetas
            const tagsArray = tagsInput.split(',')
                .map(tag => tag.trim())
                .filter(tag => tag !== '');
            
            const tags = tagsArray.map(tag => {
                const colorInput = document.getElementById(`color-${tag}`);
                return {
                    text: tag,
                    color: colorInput ? colorInput.value : '#6d5dfc'
                };
            });
            
            if (editingReadingId) {
                // Editar lectura existente
                const index = onlineReadings.findIndex(reading => reading.id === editingReadingId);
                if (index !== -1) {
                    onlineReadings[index] = {
                        ...onlineReadings[index],
                        title,
                        url,
                        author,
                        description,
                        chapter,
                        chapUrl,
                        tags
                    };
                }
            } else {
                // Añadir nueva lectura
                const newReading = {
                    id: Date.now().toString(),
                    title,
                    url,
                    author,
                    description,
                    chapter,
                    chapUrl,
                    tags,
                    dateAdded: new Date().toISOString()
                };
                onlineReadings.push(newReading);
            }
            
            saveReadings();
            readingModal.style.display = 'none';
            renderOnlineReadings();
            updateTagFilterOptions();
        }

        // Editar lectura online
        function editReading(id) {
            const reading = onlineReadings.find(reading => reading.id === id);
            if (!reading) return;
            
            editingReadingId = id;
            readingModalTitle.textContent = 'Editar Lectura Online';
            
            document.getElementById('reading-title').value = reading.title;
            document.getElementById('reading-author').value = reading.author || '';
            document.getElementById('reading-url').value = reading.url;
            document.getElementById('reading-chapter').value = reading.chapter || '';
            document.getElementById('readingchap-url').value = reading.chapUrl;
            document.getElementById('reading-description').value = reading.description || '';
            
            const tagsText = reading.tags ? reading.tags.map(tag => tag.text).join(', ') : '';
            document.getElementById('reading-tags').value = tagsText;
            
            // Generar campos de color para las etiquetas
            const tagsArray = reading.tags ? reading.tags.map(tag => tag.text) : [];
            generateTagColorInputs(tagsArray);
            
            // Establecer los colores guardados
            if (reading.tags) {
                reading.tags.forEach(tag => {
                    const colorInput = document.getElementById(`color-${tag.text}`);
                    if (colorInput) {
                        colorInput.value = tag.color;
                    }
                });
            }
            
            readingModal.style.display = 'flex';
        }

        // Eliminar lectura online
        function deleteReading(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta lectura online?')) {
                return;
            }
            
            onlineReadings = onlineReadings.filter(reading => reading.id !== id);
            
            saveReadings();
            renderOnlineReadings();
            updateTagFilterOptions();
        }

        // Guardar lecturas online en localStorage
        function saveReadings() {
            localStorage.setItem('onlineReadings', JSON.stringify(onlineReadings));
        }

        // Agregar al setup de event listeners
        function setupReadingEventListeners() {
            // Event listeners para modales de lectura online
            addReadingBtn.addEventListener('click', () => {
                editingReadingId = null;
                readingModalTitle.textContent = 'Añadir Nueva Lectura Online';
                readingForm.reset();
                tagColorsContainer.innerHTML = '<p>Introduce etiquetas para asignarles colores</p>';
                readingModal.style.display = 'flex';
            });
            
            closeReadingModal.addEventListener('click', () => {
                readingModal.style.display = 'none';
            });
            
            // Evento para generar campos de color al cambiar las etiquetas
            document.getElementById('reading-tags').addEventListener('input', function(e) {
                const tagsText = e.target.value;
                const tagsArray = tagsText.split(',')
                    .map(tag => tag.trim())
                    .filter(tag => tag !== '');
                
                generateTagColorInputs(tagsArray);
            });
            
            // Cerrar modal al hacer clic fuera
            window.addEventListener('click', (e) => {
                if (e.target === readingModal) {
                    readingModal.style.display = 'none';
                }
            });
            
            // Event listener para filtrar por etiqueta
            filterTagSelect.addEventListener('change', renderOnlineReadings);
            
            // Event listener para formulario de lecturas
            readingForm.addEventListener('submit', handleReadingFormSubmit);
        }

      // Inicializar la aplicación
      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>
